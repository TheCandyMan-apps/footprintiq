name: Production Build & Security Verification
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-verify:
    name: Build, Lint & Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript type check
        run: npx tsc --noEmit
        
      - name: Run ESLint with security rules
        run: npx eslint --config .eslintrc.ci.json src/
        continue-on-error: false
      
      - name: Check for exposed secrets
        run: |
          echo "ðŸ” Scanning for exposed API keys in client code..."
          if grep -rE "VITE_.*_KEY\s*=" .env* 2>/dev/null; then
            echo "âŒ ERROR: Found exposed VITE_*_KEY in .env files"
            exit 1
          fi
          if grep -rE "import\.meta\.env\.VITE_.*_KEY" src/providers src/pages src/components 2>/dev/null; then
            echo "âŒ ERROR: Found VITE_*_KEY access in client code"
            exit 1
          fi
          echo "âœ… No exposed secrets detected"
      
      - name: Production build
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Generate build attestation
        run: |
          echo "BUILD_ID=$(git rev-parse HEAD)" > build_attest.txt
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> build_attest.txt
          echo "BUILDER=github-actions" >> build_attest.txt
          echo "NODE_VERSION=$(node --version)" >> build_attest.txt
          echo "NPM_VERSION=$(npm --version)" >> build_attest.txt
          echo "COMMIT_SHA=${{ github.sha }}" >> build_attest.txt
          echo "COMMIT_REF=${{ github.ref }}" >> build_attest.txt
          find dist -type f -exec sha256sum {} \; >> build_attest.txt
      
      - name: Upload build attestation
        uses: actions/upload-artifact@v4
        with:
          name: build-attestation-${{ github.run_id }}
          path: build_attest.txt
          retention-days: 90
      
      - name: OSV vulnerability scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: "./"
        continue-on-error: true
      
      - name: Serve build for Lighthouse
        run: |
          npm install -g serve
          serve -s dist -l 4173 &
          sleep 5
        
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun \
            --collect.url=http://localhost:4173 \
            --collect.numberOfRuns=1 \
            --assert.preset=lighthouse:recommended \
            --upload.target=temporary-public-storage || echo "âš ï¸ Lighthouse warnings detected"
      
      - name: Summary
        if: success()
        run: |
          echo "âœ… TypeScript validation passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security lint rules passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No exposed secrets found" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production build successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build attestation generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Lighthouse CI completed" >> $GITHUB_STEP_SUMMARY
